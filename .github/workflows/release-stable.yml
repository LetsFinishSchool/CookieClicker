on:
    push:
        tags:
            - "v*"

name: Publish Cookie Clicker Stable

jobs:
    create-release:
        name: Create Release
        runs-on: ubuntu-latest
        steps:
            - name: Get current time
              uses: srfrnk/current-time@master
              id: current-time
              with:
                format: DD.MM.YYYY HH:mm [UTC]
            - name: Checkout code
              uses: actions/checkout@v2
            - name: 'Get Previous tag'
              id: previoustag
              uses: "WyriHaximus/github-action-get-previous-tag@v1"
            - name: read changelog file
              uses: juliangruber/read-file-action@v1
              id: changelog
              with:
                path: ./changelog.md
            - name: Split Changelog
              id: split
              uses: rishabhgupta/split-by@v1
              with:
                string: ${{ steps.changelog.outputs.content }}
                split-by: "========"
            - name: Create Release
              uses: ncipollo/release-action@v1
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                name: release ${{ steps.previoustag.outputs.tag }} --- ${{ steps.current-time.outputs.formattedTime }}
                tag: ${{ steps.previoustag.outputs.tag }}
                body: |
                    ![GitHub release (by tag)](https://img.shields.io/github/downloads/LetsFinishSchool/CookieClicker/${{ steps.previoustag.outputs.tag }}/total)
                    ${{ steps.split.outputs._0}}
    build:
        needs: create-release
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest] # , macOS-latest doesn't work for some reason
                java: [ '15.0.0' ]
            fail-fast: false
        name: Build and publish ${{ matrix.os }}
        steps:
            - name: Git checkout
              uses: actions/checkout@v2
            - name: Set up JDK
              uses: actions/setup-java@v1
              with:
                java-version: ${{ matrix.java }}
            - name: Echo JAVA_HOME
              run: echo $JAVA_HOME
            - name: Verify Gradle Wrapper
              uses: gradle/wrapper-validation-action@v1
            - name: Execute build
              run: ./gradlew --info --stacktrace :desktop:dist
            - name: Execute runtime
              run: ./gradlew --info --stacktrace :desktop:runtime
            - name: Execute jpackage
              run: ./gradlew --info --stacktrace :desktop:jpackage
            - name: Upload DMG as an artifact
              uses: softprops/action-gh-release@v1
              with:
                files: desktop/build/jpackage/*.dmg
            - name: Upload EXE as an artifact
              uses: softprops/action-gh-release@v1
              with:
                files: desktop/build/jpackage/*.exe
            - name: Upload MSI as an artifact
              uses: softprops/action-gh-release@v1
              with:
                files: desktop/build/jpackage/*.msi
            - name: Upload DEB as an artifact
              uses: softprops/action-gh-release@v1
              with:
                files: desktop/build/jpackage/*.deb
            - name: Upload RPM as an artifact
              uses: softprops/action-gh-release@v1
              with:
                files: desktop/build/jpackage/*.rpm
    jar:
        needs: create-release
        runs-on: ubuntu-latest
        strategy:
            matrix:
                java: [ '15.0.0' ]
            fail-fast: false
        name: upload jar and app-image
        steps:
            - name: Git checkout
              uses: actions/checkout@v2
            - name: Set up JDK
              uses: actions/setup-java@v1
              with:
                java-version: ${{ matrix.java }}
            - name: Echo JAVA_HOME
              run: echo $JAVA_HOME
            - name: Verify Gradle Wrapper
              uses: gradle/wrapper-validation-action@v1
            - name: Execute build
              run: ./gradlew --info --stacktrace :desktop:build
            - name: Execute runtime
              run: ./gradlew --info --stacktrace :desktop:runtime
            - name: Execute jpackage
              run: ./gradlew --info --stacktrace :desktop:jpackage
            - name: Upload Jar as an artifact
              uses: softprops/action-gh-release@v1
              with:
                files: desktop/build/libs/*.jar
            - name: Upload App Images as an artifact
              uses: softprops/action-gh-release@v1
              with:
                files: desktop/build/distributions/*
    android:
        needs: create-release
        runs-on: ubuntu-latest
        name: Build, Sign and Upload Android apk
        steps:
            - name: git checkout
              uses: actions/checkout@v2
            - name: Set up JDK
              uses: actions/setup-java@v1
              with:
                java-version: 11
            - name: Prepare NDK dir for caching ( workaround for https://github.com/actions/virtual-environments/issues/1337 )
              run: |
                  sudo mkdir -p /usr/local/lib/android/sdk/ndk
                  sudo chmod -R 777 /usr/local/lib/android/sdk/ndk
                  sudo chown -R $USER:$USER /usr/local/lib/android/sdk/ndk
            - name: NDK Cache
              id: ndk-cache
              uses: actions/cache@v2
              with:
                path: /usr/local/lib/android/sdk/ndk
                key: ndk-cache-21.0.6113669-v2
            - name: Install NDK
              if: steps.ndk-cache.outputs.cache-hit != 'true'
              run: echo "y" | sudo /usr/local/lib/android/sdk/tools/bin/sdkmanager --install "ndk;20.1.5948944"
            - name: Setup Android SDK
              uses: android-actions/setup-android@v2
            - name: Echo JAVA_HOME
              run: echo $JAVA_HOME
            - name: Verify Gradle Wrapper
              uses: gradle/wrapper-validation-action@v1
            - name: Build apk
              run: ./gradlew --info --stacktrace :android:assembleRelease
            - name: Sign apk
              uses: r0adkll/sign-android-release@v1
              id: sign_app
              with:
                releaseDirectory: app/build/outputs/apk/release
                signingKeyBase64: ${{ secrets.SIGNING_KEY }}
                alias: ${{ secrets.ALIAS }}
                keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
                keyPassword: ${{ secrets.KEY_PASSWORD }}
              env:
                BUILD_TOOLS_VERSION: "30.0.2"
            - name: Upload Jar as an artifact
              uses: softprops/action-gh-release@v1
              with:
                files: android/build/outputs/apk/release/*.jar
